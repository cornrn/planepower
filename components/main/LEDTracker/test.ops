#!/usr/bin/env deployer

#Import libraries
import("masterTimer")
import("cameraTrigger")
import("soem_master")
import("soem_ebox")
import("LEDTracker")
 
#Create components
loadComponent("masterTimer","OCL::MasterTimer")
loadComponent("soemMaster","soem_master::SoemMasterComponent")
loadComponent("cameraTrigger","OCL::CameraTrigger")
loadComponent("LEDTracker","OCL::LEDTracker")
LEDTracker.useExternalTrigger = true

#Load properties
#loadService("LEDTracker","marshalling")
#LEDTracker.marshalling.loadProperties("../../../properties/LEDTracker/LEDTracker.cpf")


loadService("masterTimer", "marshalling")
masterTimer.marshalling.loadProperties("../../../properties/masterTimer.cpf")
var double base_hz = masterTimer.imu_target_hz

setActivity("LEDTracker",0.00,HighestPriority,ORO_SCHED_RT)
setActivity("masterTimer", 1.0 / base_hz, HighestPriority, ORO_SCHED_RT)
setActivity("cameraTrigger",0.0,HighestPriority,ORO_SCHED_RT)
soemMaster.ifname = "eth1"
setActivity("soemMaster",.005,HighestPriority,ORO_SCHED_RT)


connectPeers("cameraTrigger","soemMaster")
var ConnPolicy cp
connect("masterTimer.cameraClock","LEDTracker.triggerTimeStampIn",cp)
connect("masterTimer.cameraClock","cameraTrigger.Trigger",cp)
#connect("masterTimer.cameraClock","protobuf.portTrigger",cp)

soemMaster.configure()
soemMaster.start()

cameraTrigger.configure()
cameraTrigger.start()

LEDTracker.configure()
LEDTracker.start()

masterTimer.start()
